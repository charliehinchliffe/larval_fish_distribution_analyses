---
title: "NIMO_community_analysis"
output: console
---






load packages
```{r}
library(mgcv)
library(vegan)##loading required package
library(car)
library(FSA)
library(lubridate)
library(ggplot2)
library(pracma)
library(visreg)
#library(devtools)
#install_github('gavinsimpson/gratia')
library(gratia)
library(labdsv)

```


bring in data
```{r}
nimo.data<-read.csv("allNIMO_dist.csv", header=TRUE)
head(nimo.data)
str(nimo.data)
```


```{r}
nimo.data$Bathy <- (abs(nimo.data$Bathy)/1000)   ### make bathymetry absolute values in km units
summary(nimo.data$Bathy)

plot(log(nimo.data$Bathy)~ nimo.data$Latitude)


hist(nimo.data$Bathy)
```



#creating date variables#

```{r}
nimo.data$DateCaught <- as.Date(nimo.data$Date, "%d/%m/%Y")
nimo.data$Month <- month(nimo.data$Date)
summary(nimo.data$Month)
nimo.data$Year <- year(nimo.data$DateCaught)
nimo.data$Day <- day(nimo.data$DateCaught)
summary(nimo.data$Day)

nimo.data$dayofyear <- yday(nimo.data$DateCaught)
summary(nimo.data$dayofyear)
hist(nimo.data$dayofyear)
```

#creating Season variables

```{r}
nimo.data$Month <- as.factor(nimo.data$Month) #month as factor

nimo.data$Season <- "0" #make season variable

nimo.data$Season[nimo.data$Month  == "12"] <- "summer"
nimo.data$Season[nimo.data$Month  == "1"] <- "summer"
nimo.data$Season[nimo.data$Month  == "2"] <- "summer"

nimo.data$Season[nimo.data$Month  == "3"] <- "autumn"
nimo.data$Season[nimo.data$Month  == "4"] <- "autumn"
nimo.data$Season[nimo.data$Month  == "5"] <- "autumn"

nimo.data$Season[nimo.data$Month  == "6"] <- "winter"
nimo.data$Season[nimo.data$Month  == "7"] <- "winter"
nimo.data$Season[nimo.data$Month  == "8"] <- "winter"

nimo.data$Season[nimo.data$Month  == "9"] <- "spring"
nimo.data$Season[nimo.data$Month  == "10"] <- "spring"
nimo.data$Season[nimo.data$Month  == "11"] <- "spring"

nimo.data$Season <- as.factor(nimo.data$Season)
nimo.data$Month <- as.numeric(nimo.data$Month) 



```

#```{r}
nimo.data$Season <- as.factor(nimo.data$Season)
nimo.data$Season <- factor(nimo.data$Season, ordered = TRUE, levels = c("summer", "autumn", "winter","spring"))
summary(nimo.data$Season) 
#```


#creatingtime period levels


```{r}
nimo.data$Decade[nimo.data$Year  <= 1999] <- "1990s"
nimo.data$Decade[nimo.data$Year  <= 2009 & nimo.data$Year > 1999] <- "2000s"
nimo.data$Decade[nimo.data$Year  <= 2020 & nimo.data$Year > 2009] <- "2010s"

nimo.data$Period[nimo.data$Year  <= 1998] <- "pre1998"
nimo.data$Period[nimo.data$Year  >= 1999] <- "post1998"

nimo.data$Decade <- as.factor(nimo.data$Decade)
summary(nimo.data$Decade)

nimo.data$Period <- as.factor(nimo.data$Period)
summary(nimo.data$Period)
```




#create Region variable


```{r}
nimo.data$Region[nimo.data$Latitude  <= -40] <- "South"

nimo.data$Region[nimo.data$Latitude  <= -35 & nimo.data$Latitude > -40] <- "Mid-South"

nimo.data$Region[nimo.data$Latitude  <= -30 & nimo.data$Latitude > -35] <- "Mid-North"

nimo.data$Region[nimo.data$Latitude  > -30] <- "North"

nimo.data$Region <- as.factor(nimo.data$Region)

```


```{r}
nimo.data$Region <- as.factor(nimo.data$Region)
nimo.data$Region <- factor(nimo.data$Region, ordered = TRUE, levels = c("North", "Mid-North", "Mid-South","South"))
summary(nimo.data$Region) 
```



```{r}
# summary(nimo.data$Project_name)
# summary(nimo.data$Temperature_C)
# summary(nimo.data$Salinity)
# summary(nimo.data$Time_local)
# summary(nimo.data$Day_Night)
# summary(nimo.data$Gear_depth_m)
```

#### Standardizing depth variable.

```{r}
nimo.data$stand_depth <- as.character(nimo.data$Gear_depth_m)
```




```{r}
nimo.data$stand_depth <- as.character(nimo.data$Gear_depth_m)



nimo.data$stand_depth[nimo.data$stand_depth  == "0-25"] <- "25" #double mid point

nimo.data$stand_depth[nimo.data$stand_depth  == "0-30"] <- "30"

nimo.data$stand_depth[nimo.data$stand_depth  == "0-35"] <- "35"

nimo.data$stand_depth[nimo.data$stand_depth  == "0-40"] <- "40"

nimo.data$stand_depth[nimo.data$stand_depth  == "0-50"] <- "50"

nimo.data$stand_depth[nimo.data$stand_depth  == "0-80"] <- "80"

nimo.data$stand_depth[nimo.data$stand_depth  == "25-50"] <- "75"

nimo.data$stand_depth[nimo.data$stand_depth  == "50-75"] <- "125"

nimo.data$stand_depth[nimo.data$stand_depth  == "75-100"] <- "175"



nimo.data$stand_depth <- as.factor(nimo.data$stand_depth)

nimo.data$stand_depth <- as.numeric(nimo.data$stand_depth)

nimo.data$stand_depth <- (nimo.data$stand_depth/2)


summary(nimo.data$stand_depth)
```



## create depth factors


```{r}

nimo.data$depth_sect[nimo.data$stand_depth  >= 0 & nimo.data$stand_depth < 11] <- "a) 0-10"

nimo.data$depth_sect[nimo.data$stand_depth  >= 11 & nimo.data$stand_depth < 50] <- "b) 11-50"

nimo.data$depth_sect[nimo.data$stand_depth  >= 51 & nimo.data$stand_depth < 100] <- "c) 51-100"

nimo.data$depth_sect[nimo.data$stand_depth  >= 101 & nimo.data$stand_depth < 150] <- "d) 101-150"

nimo.data$depth_sect[nimo.data$stand_depth  >= 151] <- "e) 151+"

nimo.data$depth_sect <- as.factor(nimo.data$depth_sect)

#summary(nimo.data$depth_sect)


```





### Creating diversity variables


```{r}
larval.spp<-nimo.data[1:3193,22:241]
head(larval.spp)
```


```{r}
abundance <- rowSums(larval.spp)
richness <- specnumber(larval.spp) # richness
shannon <- diversity(larval.spp) #shannon wevaer index from vegan package
J <- shannon/log(specnumber(larval.spp)) # Evenness
shannon_effective <- exp(diversity(larval.spp))


nimo.data$shannon <- shannon
nimo.data$evenness <- J
nimo.data$richness <- richness
nimo.data$abundance <- abundance
nimo.data$shannon_effective <- shannon_effective
```



```{r}
boxplot(nimo.data$abundance ~ nimo.data$depth_sect)

plot(nimo.data$abundance~nimo.data$Bathy)

summary(nimo.data$Season)
with(nimo.data, plot(abundance ~ Bathy))



plot(nimo.data$shannon ~ nimo.data$richness)
plot(nimo.data$shannon_effective ~ nimo.data$richness)
plot(nimo.data$shannon ~ nimo.data$shannon_effective)
```


###seperate WA and east
```{r}
eastcoast <- subset(nimo.data, nimo.data$Longitude >= 130)
westcoast <- subset(nimo.data, nimo.data$Longitude <= 130)
```


##seperate Inshore and offshore
```{r}
inshore <- subset(eastcoast, eastcoast$Bathy <= .200)
offshore <- subset(eastcoast, eastcoast$Bathy >= .200)
```



```{r}
inshore
```


We are running community analyses on inshore spp


Inshore spp by volume

```{r}
spp <- inshore[1:2428,22:239]
spp <- (spp/inshore$Volume_m3)*1000 ## spp per 1000 m^-3
```




removing spp w/ sum to 0


```{r}
#summary(east.spp)
h <- colSums(spp)
h

# Write CSV in R
write.csv(h, file = "spp_sum.csv")
z <- read.csv("spp_sum.csv", header = T)
z <- subset(z, z$x == 0)
z
```

```{r}
## removing spp w/ sum to 0# from eastspp

myvars <- names(spp) %in% c("Acropomatidae_Synagrops.spp_37311949", 
                            "Aploactinidae_other_37290000",
                            "Bothidae_Crossorhombus.spp_37460907",
                            "Bovichtidae_Pseudaphritis.urvilli_37403003",
                            "Callanthiidae_other_37311957",
                            "Cepolidae_Acanthocepola.spp_37380901",
                            "Cepolidae_Owstonia.spp_37380903",
                            "Cepolidae_other_37380000",
                            "Cetomimidae_37132000",
                            "Chandidae_other_37310900",
                            "Engraulidae_other_37086000",
                            "Ipnopidae_37123000",
                            "Latridae_other_37378000",
                            "Leptobramidae_37357905",
                            "Microcanthidae_other_37361900",
                            "Ophidiidae_Brotula.spp_37228912",
                            "Plesiopidae_37316000",
                            "Terapontidae_other_37321000",
                            "Xiphiidae_Xiphias.gladius_37442001") 

spp <- spp[!myvars]
```


PCO analysis of inshor spp



```{r}
dist.bray <- dsvdis(sqrt(spp), "bray/curtis")

bray.pco <- pco(dist.bray,k=10)

barplot(bray.pco$eig)
loadings(bray.pco)

summary(bray.pco)


plot(bray.pco)




latitude <- inshore[1:2428, 9]
Region <- inshore$Region

#par(mfrow=c(1,3))

p <- plot(bray.pco, col = -latitude)
legend("topright",9.5, c("Latitude"), pch=c(1), col=c("black"))
#par(mfrow=c(1,3))

p <- plot(bray.pco, col = Region)
#legend("topright",9.5, c("Latitude"), pch=c(1), col=c("black"))

#p2 <- plot(bray.pco, col = Project)
#legend("topright",9.5, c("Project"), pch=c(1), col=c("black"))

#p3 <- plot(bray.pco, col = Gear)
#legend("topright",9.5, c("Gear Type"), pch=c(1), col=c("black"))
```




trying to observe variance explained by eigenvalues
```{r}
barplot(bray.pco$eig)

prop <- bray.pco$eig/sum(bray.pco$eig)
plot(prop)
prop
addeig <- cumsum(bray.pco$eig / sum(bray.pco$eig))  ##proportion of eigval to sum of eigvals = %variance explained
plot(addeig)

pos <- abs(bray.pco$eig)  #looking at absolute values, ignoring negetive signs
prop2 <- pos/sum(pos)
addeig2 <- cumsum(pos/ sum(pos))  ## cumulative proportions of eiganvalues
plot(prop2)
plot(addeig2)


prop2 <- data.frame(prop2)
prop2
```


### Have to remove rare species




#trying to remove species which occurr infrequently


#remove species which occur in less than 5 samples

```{r}
spp.presence <- spp 
spp.presence[spp.presence > 0] <- 1
head(spp.presence)  ## turned presence of species into 1, absent is 0


spp[is.na(spp.presence)] <- 0 # fill NA with 0
species_total <- as.data.frame(colSums(spp.presence)) # dataframe of species sums eg total abundance
names(species_total)[1] <- "Total_Presence" # rename variable 
# summary(species_total$Total_Abundance) # observe distribution
rare_species <- subset(species_total, Total_Presence < 11)  # Select species with <X occurence
rare_species_names <- row.names(rare_species) # extract species names
list(rare_species_names)

# Charlies code to remove identified species
myvars <- names(spp)  %in%  rare_species_names # not really sure what this does but it works
comb_dat <- spp[!myvars] # drop variables identified above

comb_dat
```




inshore species raw abundance
```{r}
spp.raw <-inshore[1:2428,22:239]

spp.raw
```

#removing species with low total abundance
```{r}
spp.raw[is.na(spp.raw)] <- 0 # fill NA with 0
species_total <- as.data.frame(colSums(spp.raw)) # dataframe of species sums eg total abundance
names(species_total)[1] <- "Total_Abundance" # rename variable 
summary(species_total$Total_Abundance) # observe distribution
rare_species <- subset(species_total, Total_Abundance < 35)  # Select species with X abundance - base don distribution 35 is 1st quartile
rare_species_names <- row.names(rare_species) # extract species names
rare_species_names

rare_species

# Charlies code to remove identified species
myvars2 <- names(spp)  %in%  rare_species_names # not really sure what this does but it works
comb_dat <- spp[!myvars2 & !myvars] # drop variables identified above
comb_dat

```

#removing tows with low catch


```{r}
comb_dat <- comb_dat[rowSums(comb_dat) > 5, , drop=FALSE]  # dropping tows with less than 5 ind per 1000 m ^-3
```


```{r}
comb_dat <- comb_dat[colSums(comb_dat) > 0, , drop=FALSE]  # dropping tows with less than 5 ind per 1000 m ^-3
```


```{r}
summary(rowSums(comb_dat))
```




```{r}
head(comb_dat)
```

#transpose species matrix

```{r}
intrans <-  t(comb_dat)
```


```{r}
intrans <- intrans[rowSums(intrans) > 0, , drop=FALSE]
```



Packages for cluster diagrams
```{r}
library(clustsig)
library(dendextend)
```

#create distance matrix and run Hierarchical Clustering with rare species removed, shows which species occur next to each other
```{r}
d <- vegdist(nthroot(intrans,8), method = "bray")


H.fit <- hclust(d, method="average")

plot1 <- plot(H.fit, xlab="cluster", ylab="Height", labels = F) ##labels = Project

plot2<- color_branches(H.fit, k=50, labels = TRUE) ## For colouring branches
plot(plot2, xlab="cluster", ylab="Height")

groups <- cutree(H.fit, k=50)
clusters <- data.frame(groups)
rect.hclust(H.fit, k=50, border="red") ## For boxing around branches

groups <- as.data.frame(groups)
groups

```



```{r, eval = FALSE}
df1$var <- df2$var[match(df1$match.var,df2$match.var)]





```




```{r}
comb_dat
```





Re-running PCO now with rare_species removed

```{r}
dist.bray <- dsvdis(sqrt(comb_dat), "bray/curtis")

bray.pco <- pco(dist.bray,k=10)

barplot(bray.pco$eig)
loadings(bray.pco)

summary(bray.pco)


plot(bray.pco)   ## now i need to match the tows with the removed tows with latitudes/regions for colouring

```









######### Note #### I need to match up rows from comb_dat and inshore data frames to have latitudes, perhaps a Q for Daniel's niceR lab
```{r, eval = FALSE}
lats <- inshore$Latitude[spp == comb_dat,]
```


```{r, eval = FALSE}
library(plyr)
j <- with(join.keys(a1, a2), which(spp %in% comb_dat))
```



################## Running a GLLVM instead of PCO ## model based rather than distance based ordination.
 ###Inshore spp matrix


```{r}
library(mvabund)

elements <- inshore[1:2428,22:239]



myvars <- names(elements) %in% c("Acropomatidae_Synagrops.spp_37311949", 
                            "Aploactinidae_other_37290000",
                            "Bothidae_Crossorhombus.spp_37460907",
                            "Bovichtidae_Pseudaphritis.urvilli_37403003",
                            "Callanthiidae_other_37311957",
                            "Cepolidae_Acanthocepola.spp_37380901",
                            "Cepolidae_Owstonia.spp_37380903",
                            "Cepolidae_other_37380000",
                            "Cetomimidae_37132000",
                            "Chandidae_other_37310900",
                            "Engraulidae_other_37086000",
                            "Ipnopidae_37123000",
                            "Latridae_other_37378000",
                            "Leptobramidae_37357905",
                            "Microcanthidae_other_37361900",
                            "Ophidiidae_Brotula.spp_37228912",
                            "Plesiopidae_37316000",
                            "Terapontidae_other_37321000",
                            "Xiphiidae_Xiphias.gladius_37442001") 


elements <- elements[!myvars]


elements <- mvabund(elements[,])


#head(elements)
```


```{r}
str(inshore$Period)
```


```{r}

boxplot(elements) # inspect data ranges


meanvar.plot(elements) # check mean variance relationship




library(gllvm)
#M1 <- gllvm(y = elements, formula = inshore$Latitude, family = "negative.binomial", num.lv = 2, offset = log(inshore$Volume_m3), method = "LA", plot = T) # "negative.binomial" Power=1.01
#M1 <- gllvm(elements, family = "negative.binomial", num.lv = 2, offset = log(inshore$Volume_m3), method = "LA", plot = T)

library(mvabund)

fit <- manyglm(elements ~Latitude, family = "negative.binomial", offset = log(Volume_m3),data=inshore)
fit_null <- manyglm(elements ~1, family = "negative.binomial", offset = log(Volume_m3),data=inshore)

#anova(fit_null,fit,nBoot=50) 

plot(fit)

#install ecocopula
#install.packages("devtools")
#devtools::install_github("gordy2x/ecoCopula",force=TRUE)
library(ecoCopula)
fit_cop <- cord(fit_null)
plot(fit_cop,biplot=TRUE)


score_1 <- fit_cop$scores[[1]][1,]
score_2 <- fit_cop$scores[[1]][2,]

plot_dat <- data.frame(score_1,score_2,inshore$Region, inshore$Latitude, inshore$HadISST, inshore$Period)
head(plot_dat)

library(ggplot2)

ggplot(plot_dat,aes(x=score_1,y=score_2,col=inshore.HadISST))+
  geom_point() +
  scale_color_continuous(high = "red", low = "blue")


ggplot(plot_dat,aes(x=score_1,y=score_2,col=inshore.Latitude))+
  geom_point() +
  scale_color_continuous(high = "red", low = "blue")

#str(fit_cop)


```


```{r}

p1<- ggplot(plot_dat,aes(x=score_1,y=score_2,col=inshore.Period))+
  geom_point() +
   theme(legend.position="none")


p2 <- ggplot(plot_dat,aes(x=inshore.Latitude, y=score_1, col=inshore.Period))+
  geom_point() 


p3 <-  ggplot(plot_dat,aes(x=inshore.Latitude, y=score_2, col=inshore.Period))+
  geom_point() 






ggplot(plot_dat,aes(x=inshore.Latitude, y=score_1, col=inshore.Period))+
  geom_point() +
  geom_smooth(method = 'gam', formula = y~s(x))


ggplot(plot_dat,aes(x=inshore.Latitude, y=score_2, col=inshore.Period))+
  geom_point() +
   geom_smooth(method = 'gam', formula = y~s(x))


ggplot(plot_dat,aes(x=inshore.Latitude, y=score_1, col=inshore.Period))+
  geom_point() +
  geom_smooth(method = 'glm',  formula = y~x)


ggplot(plot_dat,aes(x=inshore.Latitude, y=score_2, col=inshore.Period))+
  geom_point() +
   geom_smooth(method = 'glm', formula = y~x)




ggplot(plot_dat,aes(x=inshore.Period, y=score_1, col=inshore.Period))+
  geom_violin() +
  geom_point(position = "jitter", alpha = 0.2) +
  geom_boxplot(alpha = 0.2)

ggplot(plot_dat,aes(x=inshore.Period, y=score_2, col=inshore.Period))+
  geom_violin() +
  geom_point(position = "jitter", alpha = 0.2) +
  geom_boxplot(alpha = 0.2)
  
  #geom_smooth(method = 'glm', , formula = y~x)


south_plot <- subset(plot_dat, plot_dat$inshore.Latitude < -40)
north_plot <- subset(plot_dat, plot_dat$inshore.Latitude > -33)


ggplot(south_plot,aes(x=inshore.Period, y=score_1, col=inshore.Period))+
  geom_violin() +
  geom_point(position = "jitter", alpha = 0.2) +
  geom_boxplot(alpha = 0.2)

ggplot(south_plot,aes(x=inshore.Period, y=score_2, col=inshore.Period))+
  geom_violin() +
  geom_point(position = "jitter", alpha = 0.2) +
  geom_boxplot(alpha = 0.2)




ggplot(north_plot,aes(x=inshore.Period, y=score_1, col=inshore.Period))+
  geom_violin() +
  geom_point(position = "jitter", alpha = 0.2) +
  geom_boxplot(alpha = 0.2)

ggplot(north_plot,aes(x=inshore.Period, y=score_2, col=inshore.Period))+
  geom_violin() +
  geom_point(position = "jitter", alpha = 0.2) +
  geom_boxplot(alpha = 0.2)






```








```{r}

my_cols <- c("#E69F00", "#000000")

p1<- ggplot(plot_dat,aes(x=score_1,y=score_2))+
  geom_point(aes(color = inshore.Period), size = 4, alpha = 0.5) + 
  scale_color_manual(values = my_cols) +
  theme_classic() +
  theme(legend.position=c(0.85, .9), legend.title = element_text(size=10, face="bold"),
               legend.text = element_text(size = 10, face = "bold"))
  
p1

p2 <- ggplot(plot_dat,aes(x=inshore.Latitude, y=score_1, col=inshore.Period))+
   geom_point(aes(color = inshore.Period), size = 4, alpha = 0.5,  shape = 1) + 
  scale_color_manual(values = my_cols) +
  theme_classic() +
  theme(legend.position="none") +
  geom_smooth(method = "loess")


p3 <-  ggplot(plot_dat,aes(x=inshore.Latitude, y=score_2, col=inshore.Period))+
  geom_point(aes(color = inshore.Period), size = 4, alpha = 0.5,  shape = 1) + 
  scale_color_manual(values = my_cols) +
  theme_classic() +
  theme(legend.position="none") +
  geom_smooth(method = "loess")







library(cowplot)


el_nino_plot <- plot_grid(p1, p2, p3, labels = c('A', 'B', 'C'), label_size = 12, nrow = 1, ncol = 3)
el_nino_plot
```






```{r}
plot_dat <- data.frame(score_1,score_2,inshore$Region, inshore$Latitude, inshore$HadISST, inshore$Period)
head(plot_dat)

ggplot(plot_dat,aes(x=inshore.Latitude, y=score_1, col = inshore.Period))+
  geom_point() +
  geom_smooth(method = "gam", formula = y~s(x, k = 5)) #+
  #scale_color_continuous(high = "red", low = "blue")

ggplot(plot_dat,aes(x=inshore.Latitude, y=score_2, col = inshore.HadISST))+
  geom_point() +
  geom_smooth(method = "glm") +
  scale_color_continuous(high = "red", low = "blue")


ggplot(plot_dat,aes(x=inshore.HadISST, y=score_1, col = inshore.Latitude))+
  geom_point() +
  geom_smooth(method = "glm") +
  scale_color_continuous(high = "red", low = "blue")

ggplot(plot_dat,aes(x=inshore.HadISST, y=score_2, col = inshore.Latitude))+
  geom_point() +
  geom_smooth(method = "glm") +
  scale_color_continuous(high = "red", low = "blue")
```



























##Quantile regression of score_1 ~ temp
```{r}
library(quantreg)

qs <- c(0.05, 0.5, 0.95) ### What quantiles are we interested in... 5%, 50% and 95%

### Actual quantile regression for score 1 
qr1 <- rq(score_1 ~ inshore.HadISST, data=plot_dat, tau = qs)

SM <- summary(qr1, se = "boot", bsmethod = "wild", R = 1000)  ## method of calculating SE and bootstrap method if applicable
SM



### Buiild a ggplot
p <- ggplot(plot_dat, aes(x = inshore.HadISST, y = score_1, col = inshore.Latitude)) +
  geom_point(size = 3,na.rm = TRUE, alpha = 0.4) +
   scale_color_continuous(high = "red", low = "blue")
p <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) ## set up plot area
p <- p + geom_abline(intercept = qr1$coefficients[1,1], slope = qr1$coefficients[2,1], 
                     linetype = 'longdash' ) # 5th quantile
p <- p + geom_abline(intercept = qr1$coefficients[1,2], slope = qr1$coefficients[2,2])
                   #  linetype = 'longdash' ) # 50th quantile
p <- p + geom_abline(intercept = qr1$coefficients[1,3], slope = qr1$coefficients[2,3], 
                     linetype = 'longdash' ) # 95th quantile
p <- p + xlab("HadISST (Degrees C)")
p <- p + ylab("Score 1")
p <- p + theme(axis.text=element_text(size=16, face = "bold"))
p <- p + theme(axis.title=element_text(size=16, face = "bold"))
p <- p + theme(legend.position=c(0.15, .8), legend.title = element_text(size=16, face="bold"),
               legend.text = element_text(size = 16, face = "bold"))
p





```


```{r}
### Actual quantile regression
qr1 <- rq(score_2 ~ inshore.HadISST, data=plot_dat, tau = qs)

SM <- summary(qr1, se = "boot", bsmethod = "wild", R = 1000)  ## method of calculating SE and bootstrap method if applicable
SM



### Buiild a ggplot
p <- ggplot(plot_dat, aes(x = inshore.HadISST, y = score_2, col = inshore.Latitude)) +
  geom_point(size = 3,na.rm = TRUE, alpha = 0.4) +
   scale_color_continuous(high = "red", low = "blue")
p <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) ## set up plot area
p <- p + geom_abline(intercept = qr1$coefficients[1,1], slope = qr1$coefficients[2,1], 
                     linetype = 'longdash' ) # 5th quantile
p <- p + geom_abline(intercept = qr1$coefficients[1,2], slope = qr1$coefficients[2,2])
                   #  linetype = 'longdash' ) # 50th quantile
p <- p + geom_abline(intercept = qr1$coefficients[1,3], slope = qr1$coefficients[2,3], 
                     linetype = 'longdash' ) # 95th quantile
p <- p + xlab("HadISST (Degrees C)")
p <- p + ylab("Score 2")
p <- p + theme(axis.text=element_text(size=16, face = "bold"))
p <- p + theme(axis.title=element_text(size=16, face = "bold"))
p <- p + theme(legend.position=c(0.15, .8), legend.title = element_text(size=16, face="bold"),
               legend.text = element_text(size = 16, face = "bold"))
p
```





##Latitude Quantile regression

```{r}

#Score_1~Latitude
qr1 <- rq(score_1 ~ inshore.Latitude, data=plot_dat, tau = qs)

SM <- summary(qr1, se = "boot", bsmethod = "wild", R = 1000)  ## method of calculating SE and bootstrap method if applicable
SM



### Buiild a ggplot
p <- ggplot(plot_dat, aes(x = inshore.Latitude, y = score_1, col = inshore.HadISST)) +
  geom_point(size = 3,na.rm = TRUE, alpha = 0.4) +
   scale_color_continuous(high = "red", low = "blue")
p <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) ## set up plot area
p <- p + geom_abline(intercept = qr1$coefficients[1,1], slope = qr1$coefficients[2,1], 
                     linetype = 'longdash' ) # 5th quantile
p <- p + geom_abline(intercept = qr1$coefficients[1,2], slope = qr1$coefficients[2,2])
                   #  linetype = 'longdash' ) # 50th quantile
p <- p + geom_abline(intercept = qr1$coefficients[1,3], slope = qr1$coefficients[2,3], 
                     linetype = 'longdash' ) # 95th quantile
p <- p + xlab("latitude (Degrees S)")
p <- p + ylab("Score 1")
p <- p + theme(axis.text=element_text(size=16, face = "bold"))
p <- p + theme(axis.title=element_text(size=16, face = "bold"))
p <- p + theme(legend.position=c(0.15, .8), legend.title = element_text(size=16, face="bold"),
               legend.text = element_text(size = 16, face = "bold"))
p



#Score_2~Latitude
qr1 <- rq(score_2 ~ inshore.Latitude, data=plot_dat, tau = qs)

SM <- summary(qr1, se = "boot", bsmethod = "wild", R = 1000)  ## method of calculating SE and bootstrap method if applicable
SM



### Buiild a ggplot
p <- ggplot(plot_dat, aes(x = inshore.Latitude, y = score_2, col = inshore.HadISST)) +
  geom_point(size = 3,na.rm = TRUE, alpha = 0.4) +
   scale_color_continuous(high = "red", low = "blue")
p <- p + theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) ## set up plot area
p <- p + geom_abline(intercept = qr1$coefficients[1,1], slope = qr1$coefficients[2,1], 
                     linetype = 'longdash' ) # 5th quantile
p <- p + geom_abline(intercept = qr1$coefficients[1,2], slope = qr1$coefficients[2,2])
                   #  linetype = 'longdash' ) # 50th quantile
p <- p + geom_abline(intercept = qr1$coefficients[1,3], slope = qr1$coefficients[2,3], 
                     linetype = 'longdash' ) # 95th quantile
p <- p + xlab("latitude (Degrees S)")
p <- p + ylab("Score 2")
p <- p + theme(axis.text=element_text(size=16, face = "bold"))
p <- p + theme(axis.title=element_text(size=16, face = "bold"))
p <- p + theme(legend.position=c(0.15, .8), legend.title = element_text(size=16, face="bold"),
               legend.text = element_text(size = 16, face = "bold"))
p

```


















```{r}
#test for temp effect after accounting for latitude
#fit <- manyglm(elements ~Latitude + HadISST, family = "negative.binomial", offset = log(Volume_m3),data=inshore)
#fit_null <- manyglm(elements ~ Latitude, family = "negative.binomial", offset = log(Volume_m3),data=inshore)

#test_lat_temp <- anova(fit_null,fit,nBoot=50, p.uni = "adjusted", nboot=50) 
#test_lat_temp <- anova(fit_null,fit,nBoot=50)

#summary(test_lat_temp)

#test_lat_temp

#saveRDS(test_lat_temp, "test_lat_temp_output.rds")
test_lat_temp_output <- readRDS("test_lat_temp_output.rds")
```


Plot ordination with null model account for latitude
```{r}
fit_cop <- cord(fit_null)
#plot(fit_cop,biplot=TRUE)


score_1 <- fit_cop$scores[[1]][1,]
score_2 <- fit_cop$scores[[1]][2,]

plot_dat <- data.frame(score_1,score_2,inshore$Region, inshore$Latitude, inshore$HadISST)
head(plot_dat)


#plot ordination
ggplot(plot_dat,aes(x=score_1,y=score_2,col=inshore.HadISST))+
  geom_point() +
  scale_color_continuous(high = "red", low = "blue")




#plot score_2 on HadISST
ggplot(plot_dat,aes(x=inshore.HadISST, y=score_2, col = inshore.Latitude))+
  geom_point(alpha = 0.5) +
  geom_smooth(method = "glm") +
  scale_color_continuous(high = "red", low = "blue")
```


Accounting for temp

```{r}
fit_null <- manyglm(elements ~ HadISST, family = "negative.binomial", offset = log(Volume_m3),data=inshore)

fit_cop <- cord(fit_null)
#plot(fit_cop,biplot=TRUE)


score_1 <- fit_cop$scores[[1]][1,]
score_2 <- fit_cop$scores[[1]][2,]

plot_dat <- data.frame(score_1,score_2,inshore$Region, inshore$Latitude, inshore$HadISST)
head(plot_dat)


#plot ordination
ggplot(plot_dat,aes(x=score_1,y=score_2,col=inshore.Latitude))+
  geom_point() +
  scale_color_continuous(high = "red", low = "blue")




#plot score_2 on HadISST
ggplot(plot_dat,aes(x=inshore.Latitude, y=score_2, col = inshore.HadISST))+
  geom_point(alpha = 0.5) +
  geom_smooth(method = "glm") +
  scale_color_continuous(high = "red", low = "blue")

ggplot(plot_dat,aes(x=inshore.Latitude, y=score_1, col = inshore.HadISST))+
  geom_point(alpha = 0.5) +
  geom_smooth(method = "glm") +
  scale_color_continuous(high = "red", low = "blue")
```


```{r}
cor(x=inshore$Latitude, y = inshore$HadISST, method = "pearson")
```


```{r}
fit_temp <- manyglm(elements ~ HadISST, family = "negative.binomial", offset = log(Volume_m3), data=inshore)

#uni_test_temp <- anova(fit_temp, nBoot=50, p.uni = "adjusted") 


#capture.output(uni_test_temp, file = "many_temp_sigtest.csv")
```





### all eastcoast ordination analyses


raw abundance
```{r}
spp.raw <-eastcoast[,22:239]

spp.raw
```

#removing species with low total abundance
```{r}
spp.raw[is.na(spp.raw)] <- 0 # fill NA with 0
species_total <- as.data.frame(colSums(spp.raw)) # dataframe of species sums eg total abundance
names(species_total)[1] <- "Total_Abundance" # rename variable 
summary(species_total$Total_Abundance) # observe distribution
rare_species <- subset(species_total, Total_Abundance < 1)  # Select species with X abundance - base don distribution 35 is 1st quartile
rare_species_names <- row.names(rare_species) # extract species names
rare_species_names

rare_species
```


```{r}
library(mvabund)

elements <- eastcoast[,22:239]



myvars <- names(elements) %in% c("Acropomatidae_Synagrops.spp_37311949", 
                            "Aploactinidae_other_37290000",
                            "Bothidae_Crossorhombus.spp_37460907",
                            "Bovichtidae_Pseudaphritis.urvilli_37403003",
                            "Callanthiidae_other_37311957",
                            "Cepolidae_Acanthocepola.spp_37380901",
                            "Cepolidae_Owstonia.spp_37380903",
                            "Cepolidae_other_37380000",
                            "Cetomimidae_37132000",
                            "Chandidae_other_37310900",
                            "Engraulidae_other_37086000",
                            "Leptobramidae_37357905",
                            "Microcanthidae_other_37361900",
                            "Ophidiidae_Brotula.spp_37228912",
                            "Plesiopidae_37316000",
                            "Terapontidae_other_37321000") 


elements <- elements[!myvars]


elements <- mvabund(elements[,])


#head(elements)
```





```{r}

boxplot(elements) # inspect data ranges


meanvar.plot(elements) # check mean variance relationship


plot(elements~eastcoast$Region) # quick rough plot of elements, x axis label wrong


# 


# 
library(gllvm)
#M1 <- gllvm(y = elements, formula = inshore$Latitude, family = "negative.binomial", num.lv = 2, offset = log(inshore$Volume_m3), method = "LA", plot = T) # "negative.binomial" Power=1.01

#M1 <- gllvm(elements, family = "negative.binomial", num.lv = 2, offset = log(inshore$Volume_m3), method = "LA", plot = T)

library(mvabund)

fit <- manyglm(elements ~Latitude, family = "negative.binomial", offset = log(Volume_m3),data=eastcoast)
fit_null <- manyglm(elements ~1, family = "negative.binomial", offset = log(Volume_m3),data=eastcoast)

#anova(fit_null,fit,nBoot=50) 
#summary(fit)
plot(fit_null)

#install ecocopula
#install.packages("devtools")
#devtools::install_github("gordy2x/ecoCopula",force=TRUE)
library(ecoCopula)
fit_cop <- cord(fit_null)
plot(fit_cop,biplot=TRUE)


score_1 <- fit_cop$scores[[1]][1,]
score_2 <- fit_cop$scores[[1]][2,]

plot_dat <- data.frame(score_1,score_2,eastcoast$Region, eastcoast$Latitude, eastcoast$HadISST)
head(plot_dat)

library(ggplot2)

ggplot(plot_dat,aes(x=score_1,y=score_2,col=eastcoast.HadISST))+
  geom_point() +
  scale_color_continuous(high = "red", low = "blue")


ggplot(plot_dat,aes(x=score_1,y=score_2,col=eastcoast.Latitude))+
  geom_point() +
  scale_color_continuous(high = "red", low = "blue")

str(fit_cop)


```



### normalizing spp


```{r}

library(vegetarian)

norm_el <- eastcoast[,22:239]  #select spp data

norm_el <- as.matrix(norm_el)
norm_el <- t(norm_el) #transpose matrix so columns are sites and rows are species


norm_el <- normalize.rows(norm_el) #normalise rows (ie each spp)

rowSums(norm_el) #checking it worked (sum to 1)

norm_el <- t(norm_el)  ##re-transpose so columns are species and rows are sites

norm_abund <- rowSums(norm_el)
norm_abund

head(norm_el)
```






### looking at output from univariate test of manyglm(elements ~ HadISST, family = "negative.binomial", offset = log(Volume_m3), data=inshore) from Katana

```{r}
Uni_test_manyglm_output <- readRDS("E:/git_projects/distribution_diversity_paper/Uni_test_manyglm_output.rds")

Uni_test_manyglm_output

Uni_test_manyglm_output$uni.p
uni_p <- as.data.frame(Uni_test_manyglm_output$uni.p)
uni_p


uni_ts <- as.data.frame(Uni_test_manyglm_output$uni.test)
uni_ts

useful_output <- rbind(uni_p, uni_ts)
useful_output

useful_output <- t(useful_output)

useful_output <- as.data.frame(useful_output)

sig_out <- subset(useful_output, useful_output$HadISST <= 0.05)

sig_out






sum(useful_output$HadISST1) #whole test dev

useful_output$dev_exp <- (useful_output$HadISST1/sum(useful_output$HadISST1))*100

useful_output

library(tidyverse)
library(dplyr)

useful_output <- useful_output %>% 
  rename(
    P = HadISST,
    TS = HadISST1
    ) %>%
  select(P, TS, dev_exp)



useful_output

write.csv(useful_output, "manyglm_temp_uni.csv")




```



```{r}
##model coefficients
co <- coef(manyglm_HaDISST_model)
co <- t(co)
co <-as.data.frame(co)



head(co)

write.csv(co, "manyglm_temp_coefs.csv")
```




#trachurus plots

```{r}
tas_data <- subset(eastcoast, eastcoast$Latitude < -40)

tas_data

p<-ggplot(tas_data, aes(x=Month, y=Carangidae_Trachurus.declivus_37337002/Volume_m3, group=Month, color = NULL)) +
  xlab("Month") + ylab("Trachurus declivus per m3")  +
  geom_boxplot(outlier.alpha = F) +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 16),
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 16)) +
  theme(legend.position="none") + scale_y_log10() + scale_x_discrete(name = "Month", limits=c(1: 12))
 
p


trach_vol <- (tas_data$Carangidae_Trachurus.declivus_37337002/tas_data$Volume_m3)
abund_vol <- (tas_data$abundance/tas_data$Volume_m3)

trach_vol
abund_vol

trach_vol/abund_vol*100
mean(trach_vol/abund_vol*100, na.rm = T)



tas_sum_data <- subset(tas_data, tas_data$Season == "summer")
tas_sum_data



trach_vol <- (tas_sum_data$Carangidae_Trachurus.declivus_37337002/tas_sum_data$Volume_m3)
abund_vol <- (tas_sum_data$abundance/tas_sum_data$Volume_m3)

trach_vol
abund_vol

trach_vol/abund_vol*100
mean(trach_vol/abund_vol*100, na.rm = T)
```




```{r}
tas_sum_data <- subset(tas_data, tas_data$Season == "winter")
tas_sum_data



trach_vol <- (tas_sum_data$Carangidae_Trachurus.declivus_37337002/tas_sum_data$Volume_m3)
abund_vol <- (tas_sum_data$abundance/tas_sum_data$Volume_m3)

trach_vol
abund_vol

trach_vol/abund_vol*100
mean(trach_vol/abund_vol*100, na.rm = T)
```



```{r}



mydata <- tas_data

mydata$Date <- as.Date(as.character(mydata$Date), format = "%d/%m/%Y")

mydata$Year <- as.numeric(year(mydata$Date))

mydata$Month <- month(mydata$Date,label = TRUE, abbr = TRUE)

table(mydata$Month)

mydata <- subset(mydata, mydata$Carangidae_Trachurus.declivus_37337002 > 0)

mydata$trach <- mydata$Carangidae_Trachurus.declivus_37337002/mydata$Volume_m3

 
mydata
```

 

```{r}

table(mydata$Month)

sum(table(mydata$Month))

```





```{r}
p<-ggplot(tas_data, aes(x=Season, y=Carangidae_Trachurus.declivus_37337002/Volume_m3, group=Season, color = NULL)) +
  xlab("Month") + ylab("Trachurus declivus per m3")  +
  geom_boxplot(outlier.alpha = F) +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 16),
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 16)) +
  theme(legend.position="none") + scale_y_log10() #+ scale_x_discrete(name = "Month", limits=c(1: 12))
 
p
```






```{r}
north_data <- subset(eastcoast, eastcoast$Latitude > -32)

north_data



p <- ggplot(north_data, aes(x=Season, y=(abundance/Volume_m3)*1000, group=Season, color = NULL)) +
  xlab("Season") + ylab("ind per m3")  +
  geom_boxplot(outlier.alpha = F) +
  theme_classic() +
  theme(axis.title.x = element_text(face="bold", colour="black", size = 20),
        axis.text.x  = element_text(colour="black", size = 16),
        axis.title.y = element_text(face="bold", colour="black", size = 20),
        axis.text.y  = element_text(colour="black", size = 16)) +
  theme(legend.position="none") #+ scale_y_log10() #+ scale_x_discrete(name = "Month", limits=c(1: 12))
 
p
```



```{r}
p <- ggplot(eastcoast, aes(x=Latitude, y = Syngnathidae_Stigmatopora.nigra_37282018/Volume_m3, col = Project_name)) +
  geom_point()

p
```



