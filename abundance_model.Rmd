---
title: "Abundance_model"
---



The notebook contains the analysis of larval fish abundance, using gerneralized additive models (GAMs)

# Setup 

load packages
```{r}
library(mgcv)
library(vegan)##loading required package
library(car)
library(FSA)
library(lubridate)
library(ggplot2)
library(pracma)
library(visreg)
#library(devtools)
#devtools::install_github('gavinsimpson/gratia')
library(gratia)

```


bring in data
```{r}
nimo.data <- read.csv("data/all_data.csv", header=TRUE)
head(nimo.data)
```


```{r}
### make bathymetry absolute values in km units
nimo.data$Bathy <- (abs(nimo.data$Bathy)/1000)   

summary(nimo.data$Bathy)

plot(log(nimo.data$Bathy) ~ nimo.data$Latitude)


hist(nimo.data$Bathy)
```

# Data processing

## Creating date variables

```{r}
nimo.data$DateCaught <- as.Date(nimo.data$Date, "%d/%m/%Y")
nimo.data$Month <- month(nimo.data$DateCaught)
summary(nimo.data$Month)

nimo.data$Year <- year(nimo.data$DateCaught)
nimo.data$Day <- day(nimo.data$DateCaught)
summary(nimo.data$Day)

nimo.data$dayofyear <- yday(nimo.data$DateCaught)
summary(nimo.data$dayofyear)
hist(nimo.data$dayofyear)
```

## Creating Season variables

```{r}
#make season variable
nimo.data$Season <- NA_character_ 

nimo.data$Season[nimo.data$Month %in% c(1,2,12)] <- "summer"
nimo.data$Season[nimo.data$Month %in% 3:5] <- "autumn"
nimo.data$Season[nimo.data$Month %in% 6:8] <- "winter"
nimo.data$Season[nimo.data$Month %in% 9:11] <- "spring"

nimo.data$Season <- factor(nimo.data$Season, ordered = TRUE, levels = c("summer", "autumn", "winter","spring"))
```

## Creating time period levels


```{r}
nimo.data$Decade[nimo.data$Year  <= 1999] <- "1990s"
nimo.data$Decade[nimo.data$Year  <= 2009 & nimo.data$Year > 1999] <- "2000s"
nimo.data$Decade[nimo.data$Year  <= 2020 & nimo.data$Year > 2009] <- "2010s"

nimo.data$Period[nimo.data$Year  <= 1998] <- "pre1998"
nimo.data$Period[nimo.data$Year  >= 1999] <- "post1998"

nimo.data$Decade <- as.factor(nimo.data$Decade)
summary(nimo.data$Decade)

nimo.data$Period <- as.factor(nimo.data$Period)
summary(nimo.data$Period)
```




## Region variable


```{r}
nimo.data$Region[nimo.data$Latitude  <= -40] <- "South"
nimo.data$Region[nimo.data$Latitude  <= -35 & nimo.data$Latitude > -40] <- "Mid-South"
nimo.data$Region[nimo.data$Latitude  <= -30 & nimo.data$Latitude > -35] <- "Mid-North"
nimo.data$Region[nimo.data$Latitude  > -30] <- "North"
nimo.data$Region <- factor(nimo.data$Region, levels = c("North", "Mid-North", "Mid-South","South"))
summary(nimo.data$Region) 
```



```{r}
# summary(nimo.data$Project_name)
# summary(nimo.data$Temperature_C)
# summary(nimo.data$Salinity)
# summary(nimo.data$Time_local)
# summary(nimo.data$Day_Night)
# summary(nimo.data$Gear_depth_m)
```

## Standardizing depth variable.

```{r}
nimo.data$stand_depth <- as.character(nimo.data$Gear_depth_m)
```


```{r}
nimo.data$stand_depth <- as.character(nimo.data$Gear_depth_m)



nimo.data$stand_depth[nimo.data$stand_depth  == "0-25"] <- "25" #double mid point

nimo.data$stand_depth[nimo.data$stand_depth  == "0-30"] <- "30"

nimo.data$stand_depth[nimo.data$stand_depth  == "0-35"] <- "35"

nimo.data$stand_depth[nimo.data$stand_depth  == "0-40"] <- "40"

nimo.data$stand_depth[nimo.data$stand_depth  == "0-50"] <- "50"

nimo.data$stand_depth[nimo.data$stand_depth  == "0-80"] <- "80"

nimo.data$stand_depth[nimo.data$stand_depth  == "25-50"] <- "75"

nimo.data$stand_depth[nimo.data$stand_depth  == "50-75"] <- "125"

nimo.data$stand_depth[nimo.data$stand_depth  == "75-100"] <- "175"



nimo.data$stand_depth <- as.factor(nimo.data$stand_depth)

nimo.data$stand_depth <- as.numeric(nimo.data$stand_depth)

nimo.data$stand_depth <- (nimo.data$stand_depth/2)


summary(nimo.data$stand_depth)
```

## create depth factors


```{r}

nimo.data$depth_sect[nimo.data$stand_depth  >= 0 & nimo.data$stand_depth < 11] <- "a) 0-10"

nimo.data$depth_sect[nimo.data$stand_depth  >= 11 & nimo.data$stand_depth < 50] <- "b) 11-50"

nimo.data$depth_sect[nimo.data$stand_depth  >= 51 & nimo.data$stand_depth < 100] <- "c) 51-100"

nimo.data$depth_sect[nimo.data$stand_depth  >= 101 & nimo.data$stand_depth < 150] <- "d) 101-150"

nimo.data$depth_sect[nimo.data$stand_depth  >= 151] <- "e) 151+"

nimo.data$depth_sect <- as.factor(nimo.data$depth_sect)

#summary(nimo.data$depth_sect)


```



## Creating diversity variables


```{r}
larval.spp<-nimo.data[1:3193,22:241]
head(larval.spp)
```


```{r}
abundance <- rowSums(larval.spp)
richness <- specnumber(larval.spp) # richness
shannon <- diversity(larval.spp) #shannon wevaer index from vegan package
J <- shannon/log(specnumber(larval.spp)) # Evenness
shannon_effective <- exp(diversity(larval.spp))


nimo.data$shannon <- shannon
nimo.data$evenness <- J
nimo.data$richness <- richness
nimo.data$abundance <- abundance
nimo.data$shannon_effective <- shannon_effective
```



```{r}
boxplot(nimo.data$abundance ~ nimo.data$depth_sect)

plot(nimo.data$abundance~nimo.data$Bathy)

summary(nimo.data$Season)
with(nimo.data, plot(abundance ~ Bathy))



plot(nimo.data$shannon ~ nimo.data$richness)
plot(nimo.data$shannon_effective ~ nimo.data$richness)
plot(nimo.data$shannon ~ nimo.data$shannon_effective)
```


## Seperate WA and east
```{r}
eastcoast <- subset(nimo.data, nimo.data$Longitude >= 130)
westcoast <- subset(nimo.data, nimo.data$Longitude <= 130)
```


```{r}
eastcoast$SST <- as.numeric(eastcoast$SST)
eastcoast$HadISST <- as.numeric(eastcoast$HadISST)

cor.test(eastcoast$SST,eastcoast$HadISST, method = c("pearson", "kendall", "spearman"))

plot(x = eastcoast$SST,y = eastcoast$HadISST)

```

```{r}
head(eastcoast)

eastcoast$Bathy <- as.numeric(eastcoast$Bathy)
eastcoast$Bathym_m <- as.numeric(eastcoast$Bathym_m)

cor.test(eastcoast$Bathy,eastcoast$Bathym_m, method = c("pearson", "kendall", "spearman"))

plot(x = eastcoast$Bathy, y = eastcoast$Bathym_m)

```


## Seperate Inshore and Offshore
```{r}
inshore <- subset(eastcoast, eastcoast$Bathy <= .200)
offshore <- subset(eastcoast, eastcoast$Bathy >= .200)
```


```{r}
summary(eastcoast$Bathym_m)
summary(eastcoast$Temperature_C)
summary(eastcoast$Salinity)
summary(eastcoast$Gear_mesh_um)

```



Abundance model selection



```{r}
eastcoast$Bathy[is.na(eastcoast$Bathy)] <- 0


str(eastcoast$Bathy)
```



```{r}
###testing correlation; Pearson correlation between predictors.

preds <- data.frame(eastcoast$Latitude, eastcoast$HadISST, eastcoast$stand_depth, eastcoast$Bathy, eastcoast$dists_km, eastcoast$Temperature_C, eastcoast$SST)

cor(preds)


cor(eastcoast$Bathy, eastcoast$dists_km)
```





```{r, eval = FALSE}
new <- subset(eastcoast, eastcoast$Project_name == "Investigator_14")

new$Season
new$Bathy
new$stand_depth
new$Latitude
new$Volume_m3

#Season +  exp(-Bathy)  + s(stand_depth, bs =  "cr", k = 5) + s(Latitude, bs =  "fs", xt = "cs", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re")


print(is.na(eastcoast)
      


      
eastcoast$find_na <- ""
                  
      
eastcoast$find_na[is.na(eastcoast$Bathy) == "TRUE"] <- "missing"  
eastcoast$find_na[is.na(eastcoast$Season) == "TRUE"] <- "missing"  
eastcoast$find_na[is.na(eastcoast$stand_depth) == "TRUE"] <- "missing"  
eastcoast$find_na[is.na(eastcoast$Latitude) == "TRUE"] <- "missing"  
eastcoast$find_na[is.na(eastcoast$Volume_m3) == "TRUE"] <- "missing"  
eastcoast$find_na[is.na(eastcoast$Project_name) == "TRUE"] <- "missing"  

as.factor(eastcoast$find_na)

print[eastcoast$find_na == "missing"]
```

# Model selection

## Step 1) Full model

```{r}
model1 <-  gam(
  abundance ~  Season + Period +  exp(-Bathy)  +  s(stand_depth, bs =  "cs", k = 5) + s(dists_km, bs =  "cs", k = 5) + s(HadISST, bs =  "cs", k = 5)  + s(Latitude, bs =  "fs", xt = "cs", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), 
  method = "REML", fit=TRUE,  Select=TRUE)


concurvity(model1, full=T) #checking concurvity
```

## Step 2)  s(dists_km, bs =  "cs", k = 5) + s(HadISST, bs =  "cs", k = 5)  removed due to concurvity

```{r}
model2 <-  gam(
  abundance ~  Season + Period +  exp(-Bathy)  +  s(stand_depth, bs =  "cs", k = 5)  + s(Latitude, bs =  "fs", xt = "cs", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), method = "REML", fit=TRUE,  Select=TRUE)
```


## Step 3) Period removed based on AIC score, checked with chi-sq test

```{r}
model2i <-  gam(abundance ~  Season  +  exp(-Bathy)  +  s(stand_depth, bs =  "cs", k = 5)  + s(Latitude, bs =  "fs", xt = "cs", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), method = "REML", fit=TRUE,  Select=TRUE)

AIC(model2,model2i) ## AIC reduced with period removed

anova(model2,model2i, test = "Chisq") #non sig therefore can remove period (adds nothing to model)
```

## Step 4) linear Season term removed, but increases AIC and is sig dif in chi-sq test there retain Season in model

```{r}
model3 <-  gam(abundance ~  exp(-Bathy)  +  s(stand_depth, bs =  "cs", k = 5)  + s(Latitude, bs =  "fs", xt = "cs", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), method = "REML", fit=TRUE,  Select=TRUE)

AIC(model3,model2i) ## AIC increased when season removed. ## model2i best model here. 

anova(model3,model2i, test = "Chisq")  #sig dif therefore dont remove season
```

Therefore best model for abundance appears to be model2i, removing Period based on AIC and s(dists_km, bs =  "cs", k = 5) + s(HadISST, bs =  "cs", k = 5) based on concurvity.

## Best model summary

```{r}
summary(model2i) 
```

checking concurvity

```{r}
concurvity(model2i,full=TRUE)
```

checking assumptions

```{r}
gam.check(model2i)
```


```{r}
par(mfcol=c(3,2))
plot(model2i, shade = TRUE)
visreg(model2i) 
appraise(model2i)
```


Overdisperison test

```{r}
E1 <- resid(model2i, type = "pearson")   #ok - less than 2
N <- nrow(eastcoast)
p <- length(coef(model2i))
Overdispersion <- sum(E1^2) / (N - p)
paste('Overdispersion: ',Overdispersion)
```


# Abundance model

Checking (bs = cr) vs (bs = cs), cr is cubic regression spline and cs is cubic regression spline with shrinkage.


AIC is lower with cr for obvious reasons - cs pushes effect size towards 0 if small.

```{r}

#Best model
modelcs <- gam(abundance ~  Season +  exp(-Bathy)  +  s(stand_depth, bs =  "cs", k = 5) + s(Latitude, bs =  "fs", xt = "cs", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), method = "REML", fit=TRUE,  Select=TRUE) 


modelcr <- gam(abundance ~  Season +  exp(-Bathy) + s(stand_depth, bs =  "cr", k = 5) + s(Latitude, bs =  "fs", xt = "cr", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), method = "REML", fit=TRUE,  Select=TRUE) 
# bs = cr cubic regression spline

AIC(modelcs, modelcr)
```

```{r}
plot(modelcs)
appraise(modelcs)
```

```{r}
summary(modelcs)
```


```{r}
concurvity(modelcs,full=T) ###  s(dists_km) displayed high concurvity; observed    1   0.7807189
```

```{r}
E1 <- resid(modelcs, type = "pearson")   #ok - less than 2
N <- nrow(eastcoast)
p <- length(coef(modelcs))
Overdispersion <- sum(E1^2) / (N - p)
paste('Overdispersion: ',Overdispersion)
```



Plotting params from model in one plot

```{r}
#plot bathy effect
z <- evaluate_parametric_term(modelcs, "exp(-Bathy)")
z


pbath <- ggplot(z, aes(x = value, y = partial)) +
  geom_line(rugs = T) +
  geom_ribbon(data=z,aes(ymin=upper,ymax=lower),alpha=0.3) +
  xlab("exp(-Bathy)") +
  ylab("Partial effect of exp(-Bathy)")  +
  geom_rug(sides ="b", color="black") +
  theme_bw() + theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + theme(plot.margin = margin(30,20,32,24))
  

pbath


library(gridGraphics)
library(cowplot)
library(ggpubr)







#install.packages("grid")
#install.packages("ggplotify")
library("grid")
library("ggplotify")


#plot smooth effect and save as grob file
p1 <- as.grob(function() plot(modelcs, shade = TRUE, select = 1))
p1

p2 <- as.grob(function() plot(modelcs, shade = TRUE, select = 2))
p2


p3 <- as.grob(function() plot(modelcs, shade = TRUE, select = 3))
p3

p4 <- as.grob(function() plot(modelcs, shade = TRUE, select = 4))
p4

p5 <- as.grob(function() plot(modelcs, shade = TRUE, select = 5))
p5

abund_gam_effects <- plot_grid(pbath, p1, p4, p2, p5, p3, labels = c('A', 'B', 'C', 'D', 'E', 'F'), label_size = 12, nrow = 3, ncol = 2)
abund_gam_effects

```






# Checking spatial autocorrelation of abundance model

Moran's I    Expected I     Z resampling   P-value resampling   Z randomization  P-value randomization
0.02829349   -0.0003327787      7.50697       6.051145e-14        7.508436          5.983793e-14


Moran's I ??? 0 therefore no problem with spatial autocorrelation

```{r, eval = FALSE}
library(lctools)

head(eastcoast)


res <- residuals(modelcs)
#res


Coords <-cbind(eastcoast$Latitude, eastcoast$Longitude)

bw <- 6

mI <-moransI(Coords,bw,res)

moran.table <-matrix(data=NA,nrow=1,ncol=6)

col.names <-c("Moran's I", "Expected I", "Z resampling", "P-value resampling","Z randomization", "P-value randomization")

colnames(moran.table) <- col.names

moran.table[1,1] <- mI$Morans.I

moran.table[1,2] <- mI$Expected.I

moran.table[1,3] <- mI$z.resampling

moran.table[1,4] <- mI$p.value.resampling

moran.table[1,5] <- mI$z.randomization

moran.table[1,6] <- mI$p.value.randomization

print(moran.table)

```


Looking at residuals of model against temp.
```{r, eval = FALSE}
reg <- lm(res ~ eastcoast$HadISST)
plot(res ~ eastcoast$HadISST)
abline(reg, col = "red")

summary(reg)
coefficients(reg)
```



# Gam models with tempo for appendix

```{r, eval = FALSE}
modeltemp <- gam(abundance ~  exp(-Bathy)  +  s(stand_depth, bs =  "cs", k = 5) + s(HadISST,  bs =  "cs", k = 5) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), method = "REML", fit=TRUE,  Select=TRUE) 


summary(modeltemp)



plot(modeltemp, shade = T)
```




```{r}
modelcs <- gam(abundance ~  Season +  exp(-Bathy)  +  s(stand_depth, bs =  "cs", k = 5) + s(Latitude, bs =  "fs", xt = "cs", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), method = "REML", fit=TRUE,  Select=TRUE) 




modelcs2 <- gam(abundance ~  Season  + s(Bathy, bs =  "cs", k = 5)  +  s(stand_depth, bs =  "cs", k = 5) + s(Latitude, bs =  "fs", xt = "cs", k = 5, by = Season, id = 1) + offset(log(Volume_m3)) + s(Project_name, bs = "re"), data = eastcoast, family = nb(theta = NULL, link = "log"), method = "REML", fit=TRUE,  Select=TRUE) 


summary(modelcs)
summary(modelcs2)

AIC(modelcs, modelcs2)


plot(modelcs2)
```

